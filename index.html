<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FSP Audio ‚Äî G√ºncel</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --border:#e9e9e9;
      --muted:#6b6b6b;
      --bg:#ffffff;
      --hover:#f7f7f7;
      --active:#e8f3ff;
      --shadow: 0 12px 30px rgba(0,0,0,.12);

      --blue:#2b7cff;
      --blueGlow: 0 0 0 4px rgba(43,124,255,.24), 0 10px 22px rgba(43,124,255,.10);
      --green:#16a34a;
      --greenGlow: 0 0 0 4px rgba(22,163,74,.22), 0 10px 22px rgba(22,163,74,.10);
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 18px;
      max-width: 980px;
      color:#111;
      background: var(--bg);
      line-height: 1.10;
    }

    h1{
      font-size: 1.55rem;
      margin: 0 0 12px 0;
      font-weight: 650;
      letter-spacing: .2px;
    }

    .pageTitle{
      font-size: 1.6rem;
      font-weight: 700;
      color: #0b5fff;
      background: #f1f5ff;
      padding: 12px 16px;
      border-radius: 14px;
      margin-bottom: 14px;
    }

    /* ‚úÖ NAV */
    .navRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 0 0 12px 0;
    }
    .navLink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      color:#111;
      text-decoration:none;
      font-size: .95rem;
      line-height: 1;
      user-select:none;
      transition: background .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .navLink:hover{ background: var(--hover); }
    .navLink.on{
      border-color:var(--blue);
      background: rgba(43,124,255,.10);
      box-shadow: 0 0 0 3px rgba(43,124,255,.16) inset;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    #search{
      flex: 1 1 520px;
      min-width: 220px;
      padding: 10px 12px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      font-size: 1rem;
      outline: none;
    }

    #resetBtn{
      padding: 10px 16px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: white;
      cursor: pointer;
      font-size: 1rem;
      flex: 0 0 auto;
    }
    #resetBtn:hover{ background: var(--hover); }

    #meta{
      color: var(--muted);
      font-size: .95rem;
      margin: 6px 0 12px 2px;
      line-height: 1.05;
    }

    /* ‚úÖ Grid: Kayƒ±t | S√ºre | ‚≠ê | ‚úì | ‚¨áÔ∏é */
    .headerRow, .itemRow{
      display: grid;
      grid-template-columns: minmax(0, 1fr) 8ch 36px 36px 36px;
      align-items: center;
      column-gap: 8px;
    }

    .headerRow{
      padding: 6px 8px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.05;
    }

    .titleHead, .durHead{
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      width: 100%;
    }
    .titleHead{ justify-content:flex-start; }
    .durHead{ justify-content:flex-end; }

    .headIconCell{
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }

    .sortBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#111;
      flex: 0 0 auto;
    }
    .sortBtn:hover{ background: var(--hover); }
    .sortBtn svg{ width:14px; height:14px; }
    .sortBtn.on{
      border-color:var(--blue);
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }

    #list{
      border-bottom: 1px solid var(--border);
    }

    .itemRow{
  padding: 4px 8px;
  border-bottom: 1px solid #ececec;
  cursor: pointer;
  background: #f7f7f7;
}

#list .itemRow:nth-child(even){
  background: #eeeeee;
}

.itemRow:hover{
  background: var(--hover);
}

.itemRow.active{
  background: var(--active);
}

    .title{
      font-size: 1.02rem;
      font-weight: 500;
      line-height: 1.02;
      min-width: 0;
    }

    .dur{
      text-align:right;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      font-size: .95rem;
      user-select:none;
      white-space: nowrap;
      line-height: 1.00;
    }

    @media (max-width: 680px){
      body{ margin: 14px; }
      .headerRow, .itemRow{ grid-template-columns: minmax(0, 1fr) 8ch 36px 36px 36px; }
      .title{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #search{ flex: 1 1 100%; }
    }

    .iconBtn{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: pointer;
      user-select:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      justify-self: center;
    }
    .iconBtn:hover{ background: var(--hover); }

    .iconBtn.on{
      border-color: var(--blue);
      background: rgba(43,124,255,.10);
      box-shadow: var(--blueGlow);
    }
    .iconBtn[data-kind="check"].on{
      border-color: var(--green);
      background: rgba(22,163,74,.14);
      box-shadow: var(--greenGlow);
    }
    .iconBtn[data-kind="check"].on svg{
      stroke: var(--green);
      stroke-width: 2.6;
    }

    .iconBtn svg{ width: 14px; height: 14px; opacity: .9; }

    .filterBtn{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#111;
    }
    .filterBtn:hover{ background: var(--hover); }
    .filterBtn.on{
      border-color:var(--blue);
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }
    .filterBtn svg{ width:14px; height:14px; }

    /* Floating player */
    #floatingPlayer{
      position: fixed;
      left: max(18px, env(safe-area-inset-left));
      bottom: max(18px, env(safe-area-inset-bottom));
      width: min(720px, calc(100vw - 36px));
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      z-index: 9999;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }

    #fpHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      background: #fbfbfb;
      cursor: grab;
      user-select:none;
      gap: 10px;
      touch-action: none;
      line-height: 1.05;
    }

    #fpTitle{
      font-weight: 650;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.12;
    }

    #fpHeaderRight{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .miniBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .miniBtn:hover{ background: var(--hover); }
    .miniBtn svg{ width:16px; height:16px; }

    .speedWrap{
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 4px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: white;
      user-select:none;
    }
    .speedCtlBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      line-height: 1;
    }
    .speedCtlBtn:hover{ background: var(--hover); }

    .speedValue{
      min-width: 56px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-variant-numeric: tabular-nums;
      font-weight: 650;
      padding: 0 10px;
      cursor: default;
    }
    .speedValue.on{
      border-color:var(--blue);
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }

    #fpBody{
      padding: 10px 12px 12px 12px;
    }

    #status{
      margin: 8px 2px 0 2px;
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.05;
    }

    .plyr--audio .plyr__controls{
      border-radius: 12px;
    }

    /* ‚úÖ Mobilde player ba≈ülƒ±ƒüƒ± daha uzun g√∂r√ºns√ºn */
    @media (max-width: 680px){
      #fpHeader{ flex-wrap: wrap; gap: 8px; }
      #fpTitle{
        flex: 1 1 100%;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
      }
      #fpHeaderRight{
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Hastalƒ±k adƒ± (Dr/dr √∂ncesi) */
    .diseaseName{
      color: #c2410c; /* koyu turuncu */
      font-weight: 650;
    }
  </style>
</head>

<body>
  <h1 class="pageTitle">FSP Audio ‚Äî G√ºncel</h1>

  <nav class="navRow" aria-label="Sayfalar">
    <a class="navLink on" href="https://protokolfsp.github.io/fsp-audio/">G√ºncel</a>
    <a class="navLink" href="https://protokolfsp.github.io/FSP2022-23/">2021‚Äì23</a>
    <a class="navLink" href="https://protokolfsp.github.io/All-in-One/">All-in-One</a>
  </nav>

  <div class="topbar">
    <input id="search" type="text" placeholder="Arama (√∂r. ACS, DM, PAVK)..." />
    <button id="resetBtn" type="button">Hepsi</button>
  </div>

  <div id="meta">G√∂r√ºn…ôn: 0 / Toplam: 0</div>

  <!-- Header: Kayƒ±t | S√ºre | ‚≠ê | ‚úì | (bo≈ü) -->
  <div class="headerRow">
    <div class="colTitle">
      <div class="titleHead">
        <span>Kayƒ±t</span>
        <button id="sortDateBtn" class="sortBtn" type="button" title="Tarihe g√∂re sƒ±rala (dosya sonu)">
          <svg id="sortDateIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"/><path d="M7 14l5 5 5-5"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="colDur" style="text-align:right;">
      <div class="durHead">
        <span>S√ºre</span>
        <button id="sortDurBtn" class="sortBtn" type="button" title="S√ºreye g√∂re sƒ±rala">
          <svg id="sortDurIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"/><path d="M7 14l5 5 5-5"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="headIconCell">
      <button id="filterFav" class="filterBtn" title="Favoriler filtrele" type="button" aria-pressed="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.8 5.8 21l1.2-6.8-5-4.9 6.9-1L12 2z"/>
        </svg>
      </button>
    </div>

    <div class="headIconCell">
      <button id="filterSel" class="filterBtn" title="Se√ßilenler filtrele" type="button" aria-pressed="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
      </button>
    </div>

    <div class="headIconCell" aria-hidden="true"></div>
  </div>

  <div id="list"></div>
  <div id="status"></div>

  <div id="floatingPlayer" role="region" aria-label="Oynatƒ±cƒ±">
    <div id="fpHeader" title="S√ºr√ºkle">
      <div id="fpTitle">Bir kayƒ±t se√ß...</div>
      <div id="fpHeaderRight">
        <div id="speedWrap" class="speedWrap" aria-label="Hƒ±z">
          <button id="slowBtn" class="speedCtlBtn" type="button" title="Yava≈ülat (üê¢)">üê¢</button>
          <div id="speedValue" class="speedValue on" title="Oynatma hƒ±zƒ±">1√ó</div>
          <button id="fastBtn" class="speedCtlBtn" type="button" title="Hƒ±zlandƒ±r (üêá)">üêá</button>
        </div>

        <button id="prevBtn" class="miniBtn" type="button" title="√ñnceki">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 20L9 12l10-8v16z"/><path d="M5 19V5"/>
          </svg>
        </button>
        <button id="nextBtn" class="miniBtn" type="button" title="Sonraki">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 4l10 8-10 8V4z"/><path d="M19 5v14"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="fpBody">
      <audio id="player" class="js-player" controls preload="metadata"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // =========================
    // G√úNCEL KAYNAK (IA metadata)
    // =========================
    const IA_IDENTIFIER_1 = "vorhofflimmern-bei-bekannter-khk-dr-oemer-dr-remzi-09.05.25";

    // Download Worker
    const DL_PROXY = "https://fspdownload.protokolfsp.workers.dev/";

    // =========================
    // DOM
    // =========================
    const listEl   = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl   = document.getElementById("meta");
    const statusEl = document.getElementById("status");

    const fp = document.getElementById("floatingPlayer");
    const fpHeader = document.getElementById("fpHeader");
    const fpTitle = document.getElementById("fpTitle");

    const playerEl = document.getElementById("player");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const slowBtn = document.getElementById("slowBtn");
    const fastBtn = document.getElementById("fastBtn");
    const speedValueEl = document.getElementById("speedValue");

    const filterFavBtn  = document.getElementById("filterFav");
    const filterSelBtn  = document.getElementById("filterSel");
    const resetBtn      = document.getElementById("resetBtn");

    const sortDurBtn  = document.getElementById("sortDurBtn");
    const sortDurIcon = document.getElementById("sortDurIcon");
    const sortDateBtn  = document.getElementById("sortDateBtn");
    const sortDateIcon = document.getElementById("sortDateIcon");

    const plyr = new Plyr(playerEl, {
      seekTime: 5,
      controls: [
        "rewind",
        "play",
        "fast-forward",
        "progress",
        "current-time",
        "duration",
        "mute",
        "volume"
      ]
    });

    // =========================
    // LOCAL STORAGE (G√ºncel i√ßin ayrƒ± namespace)
    // =========================
    const LS = {
      favs:  "fsp1.favs.v1",
      sels:  "fsp1.sels.v1",
      pos:   "fsp1.fp.pos.v1",
      durs:  "fsp1.durs.v1",
      sortMode: "fsp1.sort.mode.v1",
      sortDirDur: "fsp1.sort.dur.dir.v1",
      sortDirDate: "fsp1.sort.date.dir.v1",
      speed: "fsp1.speed.v1"
    };

    const loadMap = (k) => { try { return JSON.parse(localStorage.getItem(k) || "{}"); } catch { return {}; } };
    const saveMap = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let favs  = loadMap(LS.favs);
    let sels  = loadMap(LS.sels);
    let durs  = loadMap(LS.durs);

    let filterFav  = false;
    let filterSel  = false;

    let items = [];
    let activeId = null;

    let sortMode = localStorage.getItem(LS.sortMode) || "title";
    let durSortDir  = (localStorage.getItem(LS.sortDirDur) === "desc") ? "desc" : "asc";
    let dateSortDir = (localStorage.getItem(LS.sortDirDate) === "desc") ? "desc" : "asc";

    // =========================
    // SPEED
    // =========================
    const SPEEDS = [0.5, 0.75, 0.9, 1, 1.25, 1.5, 1.75];
    let speedIndex = SPEEDS.indexOf(1);

    function fmtSpeed(v){
      const s = (Math.round(v * 100) / 100).toString();
      return s.replace(/\.0+$/,"") + "√ó";
    }

    function setSpeedUI(v){
      speedValueEl.textContent = fmtSpeed(v);
      speedValueEl.classList.add("on");
      slowBtn.disabled = (speedIndex <= 0);
      fastBtn.disabled = (speedIndex >= SPEEDS.length - 1);
      slowBtn.style.opacity = slowBtn.disabled ? 0.45 : 1;
      fastBtn.style.opacity = fastBtn.disabled ? 0.45 : 1;
    }

    function applySpeedByIndex(idx){
      speedIndex = Math.max(0, Math.min(SPEEDS.length - 1, idx));
      const v = SPEEDS[speedIndex];
      plyr.speed = v;
      localStorage.setItem(LS.speed, String(v));
      setSpeedUI(v);
    }

    function restoreSpeed(){
      const saved = Number(localStorage.getItem(LS.speed) || "1");
      if (Number.isFinite(saved)){
        const i = SPEEDS.findIndex(x => Math.abs(x - saved) < 0.001);
        applySpeedByIndex(i === -1 ? SPEEDS.indexOf(1) : i);
      } else {
        applySpeedByIndex(SPEEDS.indexOf(1));
      }
    }

    slowBtn.addEventListener("click", (e) => { e.stopPropagation(); applySpeedByIndex(speedIndex - 1); });
    fastBtn.addEventListener("click", (e) => { e.stopPropagation(); applySpeedByIndex(speedIndex + 1); });

    // =========================
    // HELPERS
    // =========================
    function escHtml(s){
      return (s ?? "").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    // Hastalƒ±k ismi = ilk "Dr" veya "dr" gelene kadarki kƒ±sƒ±m
    function highlightDisease(title){
      const raw = (title ?? "").toString();

      const m = raw.match(/\bdr\b/i);
      if (!m || m.index == null) return escHtml(raw);

      const i = m.index;
      const left = raw.slice(0, i).trimEnd();
      if (!left.trim()) return escHtml(raw);

      return `<span class="diseaseName">${escHtml(left)}</span>${escHtml(raw.slice(left.length))}`;
    }

    function foldTR(s){
      s = (s || "").toString();
      s = s.toLocaleLowerCase("tr");
      s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      s = s.replace(/ƒ±/g, "i");
      s = s.replace(/\s+/g, " ").trim();
      return s;
    }

    function guessMime(url){
      try{
        const p = new URL(url).pathname.toLowerCase();
        if (p.endsWith(".mp3")) return "audio/mpeg";
        if (p.endsWith(".m4a")) return "audio/mp4";
      }catch{}
      return "audio/*";
    }

    function fmtDur(sec){
      if (!Number.isFinite(sec) || sec <= 0) return "‚Äî";
      sec = Math.round(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const mm = String(m).padStart(2, "0");
      const ss = String(s).padStart(2, "0");
      if (h > 0) return `${h}:${mm}:${ss}`;
      return `${m}:${ss}`;
    }

    function decodeURIComponentSafe(s){
      try { return decodeURIComponent(s); } catch { return s; }
    }

    // dd.mm.yy / dd.mm.yyyy yakala (dosya adƒ± sonu)
    function parseEndDate(item){
      const raw0 = (item.name || item.file || item.title || "").toString();
      let s;
      try { s = decodeURIComponent(raw0.split("/").pop() || raw0); } catch { s = raw0; }

      s = s.replace(/\.(mp3|m4a|wav|aac|ogg|flac)$/i, "").trim();
      s = s.normalize("NFKC").replace(/\u00A0/g, " ").trim();
      s = s.trim().replace(/[)\]\s]+$/g, "").trim();

      const m = s.match(/(\d{1,2})[.\-_\u00B7](\d{1,2})[.\-_\u00B7](\d{2}|\d{4})\s*$/);
      if (!m) return null;

      const dd = Number(m[1]);
      const mm = Number(m[2]);
      let yy = Number(m[3]);
      if (yy < 100) yy = 2000 + yy;
      if (!(dd >= 1 && dd <= 31 && mm >= 1 && mm <= 12)) return null;

      const t = Date.UTC(yy, mm - 1, dd);
      if (!Number.isFinite(t)) return null;

      const d = new Date(t);
      if (d.getUTCFullYear() !== yy || (d.getUTCMonth() + 1) !== mm || d.getUTCDate() !== dd) return null;
      return t;
    }

    function arrowSvg(isAsc){
      return isAsc
        ? `<path d="M12 19V5"/><path d="M7 10l5-5 5 5"/>`
        : `<path d="M12 5v14"/><path d="M7 14l5 5 5-5"/>`;
    }

    function setSortIcons(){
      sortDurBtn.classList.remove("on");
      sortDateBtn.classList.remove("on");

      sortDurIcon.innerHTML = arrowSvg(durSortDir === "asc");
      sortDateIcon.innerHTML = arrowSvg(dateSortDir === "asc");

      if (sortMode === "dur") sortDurBtn.classList.add("on");
      if (sortMode === "date") sortDateBtn.classList.add("on");
    }

    sortDurBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sortMode !== "dur") sortMode = "dur";
      else durSortDir = (durSortDir === "asc") ? "desc" : "asc";
      localStorage.setItem(LS.sortMode, sortMode);
      localStorage.setItem(LS.sortDirDur, durSortDir);
      setSortIcons();
      render();
    });

    sortDateBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sortMode !== "date") sortMode = "date";
      else dateSortDir = (dateSortDir === "asc") ? "desc" : "asc";
      localStorage.setItem(LS.sortMode, sortMode);
      localStorage.setItem(LS.sortDirDate, dateSortDir);
      setSortIcons();
      render();
    });

    // =========================
    // DURATION LOADER
    // =========================
    const durQueue = [];
    const durLoading = new Set();
    let durActive = 0;
    const DUR_CONCURRENCY = 2;
    let rerenderTimer = null;

    function scheduleRerender(){
      if (rerenderTimer) return;
      rerenderTimer = setTimeout(() => {
        rerenderTimer = null;
        render();
      }, 120);
    }

    function requestDuration(it){
      const id = it.id;
      if (durs[id] > 0) return;
      if (durLoading.has(id)) return;
      durLoading.add(id);
      durQueue.push(it);
      pumpDurationQueue();
    }

    function pumpDurationQueue(){
      while (durActive < DUR_CONCURRENCY && durQueue.length){
        const it = durQueue.shift();
        durActive++;
        loadDurationFor(it)
          .catch(() => {})
          .finally(() => {
            durActive--;
            pumpDurationQueue();
          });
      }
    }

    function loadDurationFor(it){
      return new Promise((resolve, reject) => {
        const a = new Audio();
        a.preload = "metadata";
        a.src = it.url;

        const cleanup = () => {
          a.removeEventListener("loadedmetadata", onMeta);
          a.removeEventListener("error", onErr);
          a.src = "";
        };

        const onMeta = () => {
          const dur = a.duration;
          cleanup();
          if (Number.isFinite(dur) && dur > 0){
            durs[it.id] = dur;
            saveMap(LS.durs, durs);
            scheduleRerender();
          }
          durLoading.delete(it.id);
          resolve();
        };

        const onErr = () => {
          cleanup();
          durLoading.delete(it.id);
          reject(new Error("metadata error"));
        };

        a.addEventListener("loadedmetadata", onMeta, { once: true });
        a.addEventListener("error", onErr, { once: true });

        setTimeout(() => {
          if (!durs[it.id] && durLoading.has(it.id)){
            durLoading.delete(it.id);
            reject(new Error("timeout"));
          }
        }, 12000);
      });
    }

    // =========================
    // DOWNLOAD (worker)
    // =========================
    function makeProxyUrl(fileUrl, filename){
      const u = DL_PROXY + "?u=" + encodeURIComponent(fileUrl);
      return filename ? (u + "&f=" + encodeURIComponent(filename)) : u;
    }

    function clickDownload(href, filename){
      const a = document.createElement("a");
      a.href = href;
      a.rel = "noopener";
      a.target = "_self";
      if (filename) a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function forceDownload(fileUrl, filename){
      const proxied = makeProxyUrl(fileUrl, filename);
      try{
        clickDownload(proxied, filename);
        return;
      }catch{}

      try{
        const res = await fetch(proxied, { mode: "cors", cache: "no-store" });
        if (!res.ok) throw new Error("fetch failed");
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        clickDownload(url, filename);
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
      }catch(err){
        window.location.href = fileUrl;
      }
    }

    // =========================
    // LOAD (IA metadata)
    // =========================
    function buildDownloadUrl(identifier, name){
      const parts = (name || "").split("/").map(p => encodeURIComponent(p));
      return `https://archive.org/download/${identifier}/${parts.join("/")}`;
    }

    async function loadItems(){
      statusEl.textContent = "Y√ºkleniyor...";

      try{
        const metaUrl = `https://archive.org/metadata/${encodeURIComponent(IA_IDENTIFIER_1)}?v=${Date.now()}`;
        const res = await fetch(metaUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("IA metadata okunamadƒ±");
        const j = await res.json();

        const files = Array.isArray(j.files) ? j.files : [];
        const list = files
          .filter(f => {
            const name = (f.name || "").toLowerCase();
            if (!(name.endsWith(".m4a") || name.endsWith(".mp3"))) return false;
            if (!("source" in f)) return true;
            return (String(f.source).toLowerCase() === "original");
          })
          .map((f, idx) => {
            const name = f.name || "";
            const title = (f.title || "").trim() || decodeURIComponentSafe(name.split("/").pop() || name);
            const url = buildDownloadUrl(IA_IDENTIFIER_1, name);
            const localId = name || url || (title + "#" + idx);
            const id = "S1|" + localId;
            return { id, title, name, url, src: "S1" };
          });

        list.sort((x,y) => x.title.localeCompare(y.title, "tr"));

        items = list;
        statusEl.textContent = items.length ? "" : "Kayƒ±t bulunamadƒ±.";
        render();
      }catch(err){
        console.error(err);
        statusEl.textContent = "Liste y√ºklenemedi.";
      }
    }

    // =========================
    // FILTER + SORT + RENDER
    // =========================
    function getVisibleItems(){
      const q = foldTR((searchEl.value || "").trim());

      let arr = items.filter(it => {
        if (q && !foldTR(it.title).includes(q)) return false;
        if (filterFav && !favs[it.id]) return false;
        if (filterSel && !sels[it.id]) return false;
        return true;
      });

      if (sortMode === "dur"){
        const dir = (durSortDir === "asc") ? 1 : -1;
        arr.sort((a,b) => {
          const ha = (durs[a.id] > 0);
          const hb = (durs[b.id] > 0);
          if (ha !== hb) return ha ? -1 : 1;
          if (ha && hb){
            const da = durs[a.id];
            const db = durs[b.id];
            if (da !== db) return (da - db) * dir;
          }
          return a.title.localeCompare(b.title, "tr");
        });
      } else if (sortMode === "date"){
        const dir = (dateSortDir === "asc") ? 1 : -1;
        arr.sort((a,b) => {
          const ta = parseEndDate(a);
          const tb = parseEndDate(b);
          const ha = (ta !== null);
          const hb = (tb !== null);
          if (ha !== hb) return ha ? -1 : 1;
          if (ha && hb && ta !== tb) return (ta - tb) * dir;
          return a.title.localeCompare(b.title, "tr");
        });
      } else {
        arr.sort((a,b) => a.title.localeCompare(b.title, "tr"));
      }

      return arr;
    }

    function render(){
      const visible = getVisibleItems();
      metaEl.textContent = `G√∂r√ºn…ôn: ${visible.length} / Toplam: ${items.length}`;

      filterFavBtn.classList.toggle("on", filterFav);
      filterSelBtn.classList.toggle("on", filterSel);

      filterFavBtn.setAttribute("aria-pressed",  String(filterFav));
      filterSelBtn.setAttribute("aria-pressed",  String(filterSel));

      listEl.innerHTML = "";

      const toMeasure = (sortMode === "dur") ? items : visible;
      for (const it of toMeasure){
        if (!(durs[it.id] > 0)) requestDuration(it);
      }

      for (const it of visible){
        const row = document.createElement("div");
        row.className = "itemRow" + (it.id === activeId ? " active" : "");

        const title = document.createElement("div");
        title.className = "title";
        title.innerHTML = highlightDisease(it.title);

        const dur = document.createElement("div");
        dur.className = "dur";
        dur.textContent = (durs[it.id] > 0) ? fmtDur(durs[it.id]) : "‚Ä¶";

        const favBtn = iconButton("star", !!favs[it.id], "Favori");
        const selBtn = iconButton("check", !!sels[it.id], "Se√ß");
        const dlBtn  = iconButton("download", false, "ƒ∞ndir");

        favBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          favs[it.id] = !favs[it.id];
          saveMap(LS.favs, favs);
          render();
        });

        selBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          sels[it.id] = !sels[it.id];
          saveMap(LS.sels, sels);
          render();
        });

        dlBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const filename =
            (it.name || it.file || "").split("/").pop() ||
            (it.title || "audio").replace(/[\\/:*?"<>|]+/g, "_") + ".mp3";
          forceDownload(it.url, filename);
        });

        for (const b of [favBtn, selBtn, dlBtn]){
          b.addEventListener("pointerup", (e) => e.stopPropagation());
          b.addEventListener("pointerdown", (e) => e.stopPropagation());
        }

        row.appendChild(title);
        row.appendChild(dur);
        row.appendChild(favBtn);
        row.appendChild(selBtn);
        row.appendChild(dlBtn);

        row.addEventListener("click", () => playById(it.id));
        listEl.appendChild(row);
      }
    }

    function iconButton(kind, on, title){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "iconBtn" + (on ? " on" : "");
      btn.title = title;
      btn.dataset.kind = kind;

      if (kind === "star"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="${on ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.8 5.8 21l1.2-6.8-5-4.9 6.9-1L12 2z"/>
          </svg>`;
      } else if (kind === "check"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>`;
      } else if (kind === "download"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v12"/>
            <path d="M7 10l5 5 5-5"/>
            <path d="M5 21h14"/>
          </svg>`;
      }
      return btn;
    }

    // =========================
    // PLAYBACK
    // =========================
    function playById(id){
      const visible = getVisibleItems();
      const idx = visible.findIndex(x => x.id === id);
      if (idx === -1) return;
      playAtVisibleIndex(idx);
    }

    function playAtVisibleIndex(idx){
      const visible = getVisibleItems();
      const it = visible[idx];
      if (!it) return;

      statusEl.textContent = "";
      activeId = it.id;
      fpTitle.textContent = it.title;
      render();

      const url = it.url;
      const mime = guessMime(url);

      plyr.source = {
        type: "audio",
        title: it.title,
        sources: [{ src: url, type: mime }]
      };

      const currentSpeed = SPEEDS[speedIndex] || 1;

      const tryPlay = () => {
        plyr.speed = currentSpeed;
        const p = plyr.play();
        if (p && typeof p.catch === "function"){
          p.catch(() => {
            statusEl.textContent = "Oynatma ba≈ülatƒ±lamadƒ±. Player‚Äôdaki ‚ñ∂Ô∏é tu≈üuna bas.";
          });
        }
      };

      const onCanPlay = () => {
        playerEl.removeEventListener("canplay", onCanPlay);
        setTimeout(tryPlay, 50);
      };

      playerEl.addEventListener("canplay", onCanPlay);

      setTimeout(() => { if (playerEl.paused) tryPlay(); }, 600);
    }

    function playPrev(){
      const visible = getVisibleItems();
      if (!visible.length) return;
      let idx = visible.findIndex(x => x.id === activeId);
      if (idx === -1) idx = 0;
      idx = (idx - 1 + visible.length) % visible.length;
      playAtVisibleIndex(idx);
    }

    function playNext(){
      const visible = getVisibleItems();
      if (!visible.length) return;
      let idx = visible.findIndex(x => x.id === activeId);
      if (idx === -1) idx = 0;
      idx = (idx + 1) % visible.length;
      playAtVisibleIndex(idx);
    }

    prevBtn.addEventListener("click", playPrev);
    nextBtn.addEventListener("click", playNext);

    plyr.on("ended", () => { setTimeout(() => playNext(), 0); });

    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      const inTyping = (tag === "input" || tag === "textarea");
      if (inTyping) return;

      if (e.code === "Space"){
        e.preventDefault();
        plyr.togglePlay();
      } else if (e.code === "ArrowLeft"){
        e.preventDefault();
        playPrev();
      } else if (e.code === "ArrowRight"){
        e.preventDefault();
        playNext();
      }
    });

    // =========================
    // Filters
    // =========================
    filterFavBtn.addEventListener("click", () => { filterFav = !filterFav; render(); });
    filterSelBtn.addEventListener("click", () => { filterSel = !filterSel; render(); });

    resetBtn.addEventListener("click", () => {
      filterFav = false;
      filterSel = false;
      searchEl.value = "";

      sortMode = "title";
      localStorage.setItem(LS.sortMode, sortMode);

      setSortIcons();
      render();
    });

    searchEl.addEventListener("input", () => render());

    // =========================
    // DRAGGABLE PLAYER + clamp fix
    // =========================
    function restorePlayerPos(){
      try{
        const s = JSON.parse(localStorage.getItem(LS.pos) || "null");
        if (!s) return;
        if (typeof s.x === "number" && typeof s.y === "number"){
          fp.style.left = s.x + "px";
          fp.style.top = s.y + "px";
          fp.style.bottom = "auto";
          fp.style.right = "auto";
        }
      }catch{}
    }

    function savePlayerPos(x,y){
      localStorage.setItem(LS.pos, JSON.stringify({x,y}));
    }

    function clampPlayerToViewport(){
      const vv = window.visualViewport;
      const vw = (vv && vv.width)  ? vv.width  : window.innerWidth;
      const vh = (vv && vv.height) ? vv.height : window.innerHeight;

      const w = fp.offsetWidth;
      const h = fp.offsetHeight;

      const minX = 8;
      const minY = 8;
      const maxX = Math.max(minX, vw - w - 8);
      const maxY = Math.max(minY, vh - h - 8);

      const left = parseFloat(fp.style.left);
      const top  = parseFloat(fp.style.top);

      if (!Number.isFinite(left) || !Number.isFinite(top)) return;

      const nx = Math.min(maxX, Math.max(minX, left));
      const ny = Math.min(maxY, Math.max(minY, top));

      fp.style.left = nx + "px";
      fp.style.top  = ny + "px";
      fp.style.right = "auto";
      fp.style.bottom = "auto";

      savePlayerPos(nx, ny);
    }

    let dragging = false;
    let startX = 0, startY = 0, startLeft = 0, startTop = 0;

    fpHeader.addEventListener("pointerdown", (e) => {
      if (e.target && e.target.closest && e.target.closest("#fpHeaderRight")) return;

      dragging = true;
      fpHeader.setPointerCapture(e.pointerId);
      fpHeader.style.cursor = "grabbing";

      const rect = fp.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      startLeft = rect.left;
      startTop = rect.top;

      fp.style.left = startLeft + "px";
      fp.style.top = startTop + "px";
      fp.style.bottom = "auto";
      fp.style.right = "auto";
    });

    fpHeader.addEventListener("pointermove", (e) => {
      if (!dragging) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      const w = fp.offsetWidth;
      const h = fp.offsetHeight;

      const minX = 8;
      const minY = 8;
      const maxX = window.innerWidth - w - 8;
      const maxY = window.innerHeight - h - 8;

      const nx = Math.min(maxX, Math.max(minX, startLeft + dx));
      const ny = Math.min(maxY, Math.max(minY, startTop + dy));

      fp.style.left = nx + "px";
      fp.style.top = ny + "px";

      savePlayerPos(nx, ny);
    });

    fpHeader.addEventListener("pointerup", (e) => {
      dragging = false;
      fpHeader.style.cursor = "grab";
      try { fpHeader.releasePointerCapture(e.pointerId); } catch {}
      clampPlayerToViewport();
    });

    window.addEventListener("resize", () => clampPlayerToViewport());
    window.addEventListener("orientationchange", () => {
      setTimeout(clampPlayerToViewport, 150);
    });
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", () => clampPlayerToViewport());
    }

    // =========================
    // INIT
    // =========================
    setSortIcons();
    restorePlayerPos();
    setTimeout(clampPlayerToViewport, 0);

    restoreSpeed();
    loadItems();
  </script>
</body>
</html>
